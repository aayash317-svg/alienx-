ROLE & CONTEXT

You are a senior backend engineer and system debugger working on an existing Flask-based application called NFC Health ID System.

The system includes:

Patient registration

Insurance portal

Insurance policy creation flow

SQLite database

QR / NFC‚Äìbased identity architecture

‚ö†Ô∏è This task is NOT about adding features.
It is about analyzing and fixing a critical data-resolution bug.

üö® PROBLEM STATEMENT (CRITICAL)

Whenever an insurance officer tries to create a new policy from the Insurance Portal:

The application returns:

‚ÄúPatient ID not found‚Äù

This happens even when:

The patient is already registered

The patient email ID exists in the database

Patient data can be seen elsewhere in the system

This indicates a broken patient-identity resolution during policy creation.

üß† IMPORTANT SYSTEM PRINCIPLE (DO NOT VIOLATE)

Patient email is NOT the primary key

Patient UUID / patient_id is the primary key

Policies must always link to patient_id

Email may exist but is not sufficient for identity resolution

Any logic violating this principle is a bug.

üîç MANDATORY ANALYSIS YOU MUST PERFORM

You must analyze before fixing.
Do NOT guess or patch blindly.

1Ô∏è‚É£ Verify Database Consistency

Confirm:

Patient registration

Policy creation
use the same SQLite database file

Check for:

Multiple DB paths

DB reinitialization

Relative vs absolute DB paths

2Ô∏è‚É£ Inspect Policy Creation Logic

Identify:

How patient identity is passed to policy creation

Whether it uses:

email ‚ùå

patient_id (UUID) ‚úÖ

Detect:

Queries that search by email instead of UUID

Queries that return no rows but continue execution

3Ô∏è‚É£ Inspect Patient Lookup Query

Examine the SQL query used to fetch patient during policy creation

Verify:

Correct column name

Correct WHERE clause

Correct parameter binding

Ensure:

Failure is explicit

No silent fallback

4Ô∏è‚É£ Input Normalization Audit

Check whether:

Email has leading/trailing spaces

Case mismatch exists

Ensure:

Normalization is applied consistently

But UUID remains the authoritative identifier

5Ô∏è‚É£ Transaction & Commit Verification

Confirm:

Patient registration commits successfully

Policy creation reads committed data

Detect:

Missing commit()

Connection scope issues

üéØ EXPECTED CORRECT BEHAVIOR

After fixing:

If a patient exists:

Policy creation must succeed

‚ÄúPatient ID not found‚Äù must occur only if the patient truly does not exist

Policies must:

Always reference patient_id

Never rely solely on email

QR / NFC generation must link to the same patient_id

üîß REQUIRED CORRECTIONS (ONLY AFTER ANALYSIS)

Based on your findings, apply minimal and correct fixes, such as:

Replace email-based patient lookup with UUID-based lookup

Ensure policy creation endpoint:

Requires patient_id

Validates its existence

Fix DB path usage if inconsistent

Add clear error messages when lookup fails

‚ö†Ô∏è Do NOT auto-create patients
‚ö†Ô∏è Do NOT suppress the error
‚ö†Ô∏è Do NOT weaken validation

üîê SECURITY & DATA INTEGRITY RULES

Backend must be the single source of truth

Frontend must not decide patient identity

QR / NFC must resolve to patient_id only

No duplicate or ghost patient records

üß± CONSTRAINTS

Keep Flask + SQLite stack

Preserve existing architecture

Do not affect hospital or admin flows

Make targeted backend corrections only

üö´ WHAT YOU MUST NOT DO

Do NOT hide the error

Do NOT change unrelated code

Do NOT use email as a primary key

Do NOT bypass identity validation

‚úÖ EXPECTED OUTPUT FROM YOU

You must provide:

Root cause explanation (why patient ID not found)

Exact location of faulty logic

Corrected backend code

Confirmation that:

Existing patient ‚Üí policy creation works

Error appears only for truly missing patients

Optional SQL verification steps

FINAL INSTRUCTION

Treat this as a data-identity bug, not a UI bug.

Fix the cause, not the symptom.
