ROLE & CONTEXT

You are a senior backend engineer and system integrator working on an existing Flask-based project called NFC Health ID System.

The system already includes:

Patient records

Hospital portal

Insurance portal

SQLite database

QR code generation logic

NFC-ready encrypted ID architecture

Role-based access control

‚ö†Ô∏è This task is an extension and automation, not a rebuild.

üéØ OBJECTIVE

Whenever a new insurance policy is created, the system must automatically perform the following actions in a single workflow:

Create a new policy-specific dataset in the database

Generate a unique encrypted identifier for that policy

Automatically generate:

A QR code

An NFC ID payload

Persist all generated artifacts securely

Link them correctly to:

The patient

The insurance policy

The insurance company

No manual intervention should be required after clicking ‚ÄúCreate Policy‚Äù.

‚ùå CURRENT LIMITATION

At present:

Policies may be created manually

QR/NFC creation (if any) is separate or manual

No automatic dataset + identity generation is enforced

This must be corrected.

‚úÖ EXPECTED AUTOMATED FLOW

When an insurance officer clicks ‚ÄúCreate Policy‚Äù:

Step 1Ô∏è‚É£ Policy Dataset Creation

A new policy record is inserted into the database

Each policy must have:

A unique policy ID (UUID)

Patient reference

Insurance provider reference

Policy metadata (type, coverage, dates, status)

Step 2Ô∏è‚É£ Encrypted Identity Generation

Immediately generate a unique encrypted identifier for the policy

Encryption rules:

Use strong symmetric encryption (Fernet / AES)

Do NOT expose raw IDs

This encrypted ID will be the single source of truth for QR + NFC

Step 3Ô∏è‚É£ QR Code Generation (Automatic)

Generate a QR code that contains:

The encrypted policy identifier

Store:

QR image file (server side)

QR metadata in database

QR must be:

Unique per policy

Reproducible only via backend

Step 4Ô∏è‚É£ NFC ID Generation (Automatic)

Generate an NFC payload using the same encrypted identifier

Store:

NFC UID / payload string

Policy linkage

NFC generation must be:

Backend-only

Ready for future mobile NFC writing

For now, NFC can be simulated/stored as text payload

Step 5Ô∏è‚É£ Atomic Transaction Guarantee

All above steps must be executed as one atomic operation

If any step fails:

Roll back the entire operation

Do NOT leave partial data in DB

üîê SECURITY & INTEGRITY RULES

QR and NFC must NEVER contain raw IDs

Only backend may generate encrypted identifiers

Only authorized insurance roles may create policies

Generated QR/NFC must be read-only artifacts

No regeneration without admin permission

üóÑÔ∏è DATABASE REQUIREMENTS

You must:

Either extend or verify existing tables

Ensure clear linkage between:

Patient

Policy

QR record

NFC record

Avoid duplicating patient identity unnecessarily

Use consistent DB connection across all steps

üß± ARCHITECTURE CONSTRAINTS

Use existing Flask backend

Use existing QR generation utilities if present

Add new helper functions only where required

Keep logic inside:

Insurance policy creation API

Do NOT move this logic to frontend

üö´ WHAT YOU MUST NOT DO

Do NOT require manual QR/NFC creation

Do NOT expose encryption keys

Do NOT create QR/NFC on frontend

Do NOT split this into multiple user actions

Do NOT break existing patient or hospital flows

‚úÖ EXPECTED OUTPUT

You must provide:

Updated policy-creation backend flow

Automatic QR generation logic

Automatic NFC ID generation logic

Database linkage explanation

Confirmation that:

Creating a policy automatically creates dataset + QR + NFC

No manual steps are required

Data remains secure and consistent

FINAL INSTRUCTION

Treat this as a backend automation and identity-generation task.

Focus on:

Correct sequencing

Atomic operations

Security

Maintainability
