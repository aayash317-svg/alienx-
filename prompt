ROLE & SEVERITY

You are a principal backend architect and forensic debugger assigned to a critical identity-resolution failure in a production-grade Flask application called NFC Health ID System.

This is a high-severity data integrity issue.

You must analyze first, prove the root cause, then fix.
Do NOT guess.
Do NOT patch symptoms.

üö® CRITICAL FAILURE DESCRIPTION

The system exhibits the following incorrect behavior:

A patient already exists in the database

Verified by email ID

Patient record is present

When:

Creating a new insurance policy

OR scanning QR / NFC

OR resolving patient identity

The system responds with:

‚ÄúPatient not found‚Äù

This happens even though the patient email ID exists in the database.

This indicates a fundamental mismatch in identity resolution logic.

üß† CORE PRINCIPLE (DO NOT VIOLATE)

In this system:

Email is NOT the primary identity

Patient UUID is the primary identity

QR / NFC must resolve ‚Üí UUID, not email

Email may exist, but identity resolution may still fail

You must audit whether the system violates this principle.

üîç MANDATORY FORENSIC ANALYSIS (STEP BY STEP)

You MUST analyze all of the following, in this order:

1Ô∏è‚É£ DATABASE TRUTH VERIFICATION (CRITICAL)

You must verify:

Which database file is actually being used at runtime

Whether:

Patient registration

Policy creation

QR/NFC resolution
are all pointing to the same SQLite DB file

Check for:

Relative vs absolute DB paths

Multiple DB files accidentally created

DB re-initialization on app restart

You must prove that data is not split across DBs.

2Ô∏è‚É£ PATIENT IDENTITY MODEL AUDIT

You must inspect:

How patients are stored:

patient_id (UUID)

email

phone

How patients are retrieved during:

policy creation

QR/NFC resolution

You must answer explicitly:

Is lookup done by:

email?

UUID?

encrypted ID?

Is lookup logic consistent everywhere?

3Ô∏è‚É£ POLICY CREATION ‚Üí PATIENT LINKAGE CHECK

When a new policy is created:

How is the patient identified?

Is the policy:

Linked to patient_id (UUID)?

OR incorrectly linked to email?

You must detect and fix:

Any policy creation logic that:

Searches patient by email

Fails silently

Continues without valid patient UUID

4Ô∏è‚É£ QR / NFC RESOLUTION FLOW AUDIT

You must analyze:

What exactly is stored inside:

QR code

NFC payload

Confirm:

Encrypted value decrypts to patient UUID

NOT email

Verify:

Decryption logic

DB lookup uses UUID, not email

If email is used anywhere here ‚Üí it is a bug.

5Ô∏è‚É£ STRING NORMALIZATION ERRORS

Check for:

Email case sensitivity issues

Leading/trailing spaces

Different encodings

Inconsistent normalization between:

registration

lookup

policy creation

You must enforce:

Canonical normalization at one single point

6Ô∏è‚É£ TRANSACTION & COMMIT VERIFICATION

Verify:

Patient insert commits successfully

No rollback occurs

No shadow DB transaction exists

Confirm no race conditions or partial writes.

üéØ EXPECTED CORRECT BEHAVIOR (NON-NEGOTIABLE)

After fixing:

If a patient exists:

Policy creation must always succeed

QR/NFC resolution must always find patient

‚ÄúPatient not found‚Äù must occur only if:

Patient truly does not exist

Email existence alone must never cause ambiguity

UUID must be the single source of truth

üîß REQUIRED CORRECTIONS (ONLY AFTER PROOF)

You must:

Align all patient resolution logic to UUID

Ensure:

Policy creation uses UUID

QR/NFC resolves to UUID

Email is used only for UI convenience

Add explicit error logging where lookup fails

Remove any fallback logic that masks failures

‚ö†Ô∏è Do NOT auto-create patients
‚ö†Ô∏è Do NOT silently retry
‚ö†Ô∏è Do NOT bypass identity validation

üîê SECURITY & DATA INTEGRITY RULES

Never store email inside QR/NFC

Never trust frontend patient identifiers

Backend must enforce identity resolution

Errors must be explicit and accurate

üß± CONSTRAINTS

Must use existing Flask + SQLite stack

Must preserve architecture

Must not affect hospital / admin logic

Must not introduce new frameworks

üö´ WHAT YOU MUST NOT DO

Do NOT patch UI only

Do NOT suppress ‚Äúpatient not found‚Äù

Do NOT introduce duplicate patients

Do NOT loosen validation rules

‚úÖ EXPECTED OUTPUT FROM YOU

You must provide:

Root cause analysis (clear and proven)

Exact point where identity mismatch occurs

Corrected backend logic

Confirmation that:

Patient email existing ‚Üí policy works

QR/NFC resolution never fails incorrectly

Optional: SQL verification commands

FINAL INSTRUCTION

This is an identity-consistency repair task, not a feature request.

Treat this like a production incident post-mortem + fix.
